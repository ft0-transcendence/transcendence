services:
  nginx:
    image: nginx:alpine
    container_name: transcendence-nginx
    restart: unless-stopped
    ports:
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - nginx-certs:/etc/nginx/certs:ro
    depends_on:
      cert-generator:
        condition: service_completed_successfully
      app:
        condition: service_started

  cert-generator:
    image: alpine:latest
    container_name: transcendence-cert-generator
    volumes:
      - nginx-certs:/certs
    command: >
      sh -c "if [ ! -f /certs/cert.pem ] || [ ! -f /certs/key.pem ]; then
        echo 'Generating SSL certificates...';
        apk add --no-cache openssl;
        openssl req -x509 -newkey rsa:4096 -keyout /certs/key.pem -out /certs/cert.pem -days 365 -nodes -subj '/C=IT/ST=Italy/L=Florence/O=42School/CN=localhost';
        echo 'SSL certificates generated successfully';
      else
        echo 'SSL certificates already exist, skipping generation';
      fi"

  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: transcendence
    restart: unless-stopped
    expose:
      - "4200"
    env_file:
      - ./.env

volumes:
  nginx-certs:

